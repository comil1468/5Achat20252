<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5A Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #f0f2f5;
            --chat-bg: #ffffff;
            --text-color: #333333;
            --message-user: #0084ff;
            --message-other: #e4e6eb;
            --button-color: #1877f2;
            --border-color: #dddfe2;
            --accent-color: #ff6b6b;
        }

        .dark-theme {
            --bg-color: #18191a;
            --chat-bg: #242526;
            --text-color: #e4e6eb;
            --message-user: #0084ff;
            --message-other: #3e4042;
            --button-color: #1877f2;
            --border-color: #3e4042;
            --accent-color: #ff6b6b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            transition: all 0.3s ease;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--button-color));
        }

        .auth-box {
            background-color: var(--chat-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .logo {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .logo-subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 30px;
            color: var(--text-color);
        }

        #username-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--chat-bg);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
        }

        #login-button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .chat-interface {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background-color: var(--chat-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-small {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .current-user {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .online-count {
            font-size: 0.8em;
            opacity: 0.6;
            margin-left: 10px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--message-user);
            color: white;
        }

        .other-message {
            align-self: flex-start;
            background-color: var(--message-other);
            color: var(--text-color);
        }

        .message-sender {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 0.7em;
            opacity: 0.6;
            text-align: right;
            margin-top: 5px;
        }

        .media-content {
            max-width: 300px;
            max-height: 300px;
            margin-top: 5px;
            border-radius: 10px;
            cursor: pointer;
        }

        .input-area {
            display: flex;
            padding: 15px 20px;
            background-color: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            background-color: var(--chat-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        #file-input {
            display: none;
        }

        .file-button, #send-button {
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--chat-bg);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1000;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        .settings-overlay.active {
            display: block;
        }

        .theme-option {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--bg-color);
        }

        .theme-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid var(--border-color);
        }

        .light-preview {
            background: linear-gradient(135deg, #ffffff 50%, #f0f2f5 50%);
        }

        .dark-preview {
            background: linear-gradient(135deg, #242526 50%, #18191a 50%);
        }

        .logout-button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            padding: 15px;
            font-size: 0.9em;
            opacity: 0.7;
            background-color: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            margin-top: 20px;
        }

        .footer a {
            color: var(--text-color);
            text-decoration: none;
        }

        #settings-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }

        .media-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .media-fullscreen img,
        .media-fullscreen video {
            max-width: 90%;
            max-height: 90%;
        }

        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
        }

        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .typing-indicator {
            font-size: 0.8em;
            opacity: 0.6;
            padding: 5px 15px;
            font-style: italic;
        }

        .connection-status {
            font-size: 0.7em;
            opacity: 0.6;
            margin-left: 10px;
        }

        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
    <div class="auth-container" id="auth-container">
        <div class="auth-box">
            <div class="logo">5A</div>
            <div class="logo-subtitle">–ù–∞—Å—Ç–æ—è—â–∏–π –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç</div>
            <input type="text" id="username-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
            <div class="error-message" id="login-error">–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º</div>
            <button id="login-button">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        </div>
    </div>

    <div class="chat-interface" id="chat-interface">
        <div class="header">
            <div class="header-logo">
                <div class="logo-small">5A</div>
                <div class="current-user" id="current-user"></div>
                <div class="online-count" id="online-count"></div>
                <div class="connection-status" id="connection-status">‚óè</div>
            </div>
            <button id="settings-button">‚öôÔ∏è</button>
        </div>

        <div class="chat-container" id="chat-container">
            <div class="typing-indicator" id="typing-indicator" style="display: none;"></div>
        </div>

        <div class="input-area">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="file-button" onclick="document.getElementById('file-input').click()">üìé</button>
            <input type="file" id="file-input" accept="image/*,video/*">
            <button id="send-button">‚û§</button>
        </div>

        <div class="media-fullscreen" id="media-fullscreen">
            <button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>
        </div>

        <div class="settings-overlay" id="settings-overlay"></div>
        <div class="settings-panel" id="settings-panel">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <h3>–¶–≤–µ—Ç–æ–≤–∞—è —Ç–µ–º–∞</h3>
            <div class="theme-option" data-theme="light">
                <div class="theme-preview light-preview"></div>
                <span>–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</span>
            </div>
            <div class="theme-option" data-theme="dark">
                <div class="theme-preview dark-preview"></div>
                <span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
            </div>
            
            <button class="logout-button" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            
            <div class="footer">
                by kamorka game<br>
                <a href="https://vk.com/club230489659?from=groups" target="_blank">VK –≥—Ä—É–ø–ø–∞</a>
            </div>
        </div>
    </div>

    <script>
        // üü¢ –¢–í–û–ò –ù–ê–°–¢–û–Ø–©–ò–ï –ö–õ–Æ–ß–ò SUPABASE!
        const SUPABASE_URL = 'https://dovnjdgekkoxbttmbsns.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvdm5qZGdla2tveGJ0dG1ic25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3ODMyMzgsImV4cCI6MjA3NjM1OTIzOH0.AxrDwoqNbsNsxbmj3_OoY2q2wLzegZFdcuu04X_HuA0';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = '';
        let userId = '';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function checkConnection() {
            try {
                const { data, error } = await supabase.from('messages').select('*').limit(1);
                if (error) throw error;
                document.getElementById('connection-status').className = 'connection-status connected';
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ!');
                return true;
            } catch (error) {
                document.getElementById('connection-status').className = 'connection-status disconnected';
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            checkConnection();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const savedUser = localStorage.getItem('5a_username');
            if (savedUser) {
                loginUser(savedUser);
            } else {
                showAuth();
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        });

        function setupEventListeners() {
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('username-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('settings-button').addEventListener('click', function() {
                document.getElementById('settings-panel').classList.add('open');
                document.getElementById('settings-overlay').classList.add('active');
            });
            
            document.getElementById('settings-overlay').addEventListener('click', function() {
                document.getElementById('settings-panel').classList.remove('open');
                this.classList.remove('active');
            });
            
            // –¢–µ–º—ã
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    setTheme(theme);
                });
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ç–µ–º–∞
            const savedTheme = localStorage.getItem('5a_theme') || 'light';
            setTheme(savedTheme);
        }

        function handleLogin() {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            const errorElement = document.getElementById('login-error');
            
            if (!username) {
                errorElement.style.display = 'block';
                return;
            }
            
            errorElement.style.display = 'none';
            loginUser(username);
        }

        async function loginUser(username) {
            currentUser = username;
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            localStorage.setItem('5a_username', username);
            localStorage.setItem('5a_userId', userId);
            
            console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', username);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω
            try {
                const { error } = await supabase
                    .from('online_users')
                    .upsert({ 
                        id: userId, 
                        username: username,
                        last_seen: new Date().toISOString()
                    });

                if (error) throw error;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –æ–Ω–ª–∞–π–Ω:', error);
            }
            
            showChat();
        }

        function showAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('chat-interface').style.display = 'none';
        }

        function showChat() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            document.getElementById('current-user').textContent = currentUser;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            loadMessages();
            
            // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            listenToMessages();
            
            // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            listenToOnlineUsers();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const text = messageInput.value.trim();
            
            if (text) {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', text);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Supabase
                try {
                    const { data, error } = await supabase
                        .from('messages')
                        .insert([
                            { 
                                text: text, 
                                sender: currentUser,
                                user_id: userId
                            }
                        ]);

                    if (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                    } else {
                        console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                        messageInput.value = '';
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                }
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                console.log('üìé –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞:', file.name);
                
                // –î–ª—è —Ñ–∞–π–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ Base64 –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
                try {
                    const { data, error } = await supabase
                        .from('messages')
                        .insert([
                            { 
                                text: `üìé –§–∞–π–ª: ${file.name}`,
                                sender: currentUser,
                                user_id: userId,
                                media_data: e.target.result,
                                media_type: file.type,
                                media_name: file.name
                            }
                        ]);

                    if (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
                        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                    } else {
                        console.log('‚úÖ –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                }
            };
            
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        async function loadMessages() {
            console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(100);

                if (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                    return;
                }

                if (messages) {
                    const chatContainer = document.getElementById('chat-container');
                    const typingIndicator = document.getElementById('typing-indicator');
                    chatContainer.innerHTML = '';
                    chatContainer.appendChild(typingIndicator);
                    
                    messages.forEach(msg => {
                        addMessageToChat(msg);
                    });
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.length);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            }
        }

        function listenToMessages() {
            console.log('üëÇ –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...');
            
            // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            supabase
                .channel('messages')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'messages' }, 
                    (payload) => {
                        console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', payload.new);
                        addMessageToChat(payload.new);
                    }
                )
                .subscribe((status) => {
                    console.log('üì° –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏:', status);
                });
        }

        function listenToOnlineUsers() {
            console.log('üë• –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
            
            // –°–ª—É—à–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            supabase
                .channel('online_users')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'online_users' }, 
                    async () => {
                        await updateOnlineCount();
                    }
                )
                .subscribe();
        }

        async function updateOnlineCount() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã)
                const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000).toISOString();
                
                const { count, error } = await supabase
                    .from('online_users')
                    .select('*', { count: 'exact', head: true })
                    .gt('last_seen', twoMinutesAgo);

                if (!error && count !== null) {
                    document.getElementById('online-count').textContent = `üë• ${count} –æ–Ω–ª–∞–π–Ω`;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω:', error);
            }
        }

        function addMessageToChat(messageData) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            
            const isUser = messageData.user_id === userId;
            messageDiv.classList.add('message', isUser ? 'user-message' : 'other-message');
            
            // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            if (!isUser && messageData.sender) {
                const senderDiv = document.createElement('div');
                senderDiv.classList.add('message-sender');
                senderDiv.textContent = messageData.sender;
                messageDiv.appendChild(senderDiv);
            }
            
            // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            if (messageData.text) {
                const textDiv = document.createElement('div');
                textDiv.textContent = messageData.text;
                messageDiv.appendChild(textDiv);
            }
            
            // –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)
            if (messageData.media_data) {
                const mediaDiv = document.createElement('div');
                if (messageData.media_type.startsWith('image')) {
                    const img = document.createElement('img');
                    img.src = messageData.media_data;
                    img.classList.add('media-content');
                    img.onclick = () => showFullscreen(messageData.media_data, 'image');
                    mediaDiv.appendChild(img);
                } else if (messageData.media_type.startsWith('video')) {
                    const video = document.createElement('video');
                    video.src = messageData.media_data;
                    video.classList.add('media-content');
                    video.controls = true;
                    video.onclick = () => showFullscreen(messageData.media_data, 'video');
                    mediaDiv.appendChild(video);
                }
                messageDiv.appendChild(mediaDiv);
            }
            
            // –í—Ä–µ–º—è
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            const time = messageData.created_at ? 
                new Date(messageData.created_at).toLocaleTimeString() : 
                new Date().toLocaleTimeString();
            timeDiv.textContent = time;
            messageDiv.appendChild(timeDiv);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
            localStorage.setItem('5a_theme', theme);
        }

        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (userId) {
                    supabase
                        .from('online_users')
                        .delete()
                        .eq('id', userId);
                }
                
                localStorage.removeItem('5a_username');
                localStorage.removeItem('5a_userId');
                showAuth();
                closeSettings();
            }
        }

        function closeSettings() {
            document.getElementById('settings-panel').classList.remove('open');
            document.getElementById('settings-overlay').classList.remove('active');
        }

        function showFullscreen(src, type) {
            const fullscreen = document.getElementById('media-fullscreen');
            fullscreen.innerHTML = '<button class="close-fullscreen" onclick="closeFullscreen()">√ó</button>';
            
            let mediaElement;
            if (type === 'image') {
                mediaElement = document.createElement('img');
                mediaElement.src = src;
            } else {
                mediaElement = document.createElement('video');
                mediaElement.src = src;
                mediaElement.controls = true;
                mediaElement.autoplay = true;
            }
            
            fullscreen.appendChild(mediaElement);
            fullscreen.style.display = 'flex';
        }

        function closeFullscreen() {
            document.getElementById('media-fullscreen').style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        setInterval(async () => {
            if (currentUser) {
                try {
                    await supabase
                        .from('online_users')
                        .upsert({ 
                            id: userId, 
                            username: currentUser,
                            last_seen: new Date().toISOString()
                        });
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞:', error);
                }
            }
        }, 60000);

        // –û—á–∏—â–∞–µ–º –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', async () => {
            if (userId) {
                try {
                    await supabase
                        .from('online_users')
                        .delete()
                        .eq('id', userId);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞:', error);
                }
            }
        });
    </script>
</body>
</html>
</html>
